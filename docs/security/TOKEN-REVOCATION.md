# GitHub Token Revocation Guide

This guide explains how to revoke exposed GitHub tokens and generate new ones securely.

## Table of Contents

- [Immediate Actions](#immediate-actions)
- [Identifying Token Types](#identifying-token-types)
- [Step-by-Step Revocation](#step-by-step-revocation)
- [Generating a New Token](#generating-a-new-token)
- [Secure Token Storage](#secure-token-storage)
- [Post-Incident Audit](#post-incident-audit)

## Immediate Actions

If you suspect a token has been exposed:

1. **Revoke immediately** - Do not wait. Even a brief exposure can be exploited
2. **Do not push any more commits** until the token is revoked
3. **Check for unauthorized activity** in your GitHub security log
4. **Generate a new token** with the minimum required scopes
5. **Update all systems** that use the old token

## Identifying Token Types

GitHub uses different token prefixes to identify token types:

| Prefix | Token Type | Settings Location |
|--------|------------|-------------------|
| `ghp_` | Personal Access Token (Classic) | Settings > Developer settings > Personal access tokens > Tokens (classic) |
| `github_pat_` | Fine-grained Personal Access Token | Settings > Developer settings > Personal access tokens > Fine-grained tokens |
| `gho_` | OAuth Token | Settings > Applications > Authorized OAuth Apps |
| `ghs_` | GitHub App Installation Token | Settings > Applications > Installed GitHub Apps |
| `ghr_` | GitHub App Refresh Token | Settings > Applications > Installed GitHub Apps |

## Step-by-Step Revocation

### Revoking Personal Access Tokens (Classic) - `ghp_*`

1. Go to [GitHub Settings](https://github.com/settings/profile)
2. In the left sidebar, click **Developer settings**
3. Click **Personal access tokens** > **Tokens (classic)**
4. Find the compromised token in the list
5. Click **Delete** next to the token
6. Confirm deletion when prompted

### Revoking Fine-Grained Tokens - `github_pat_*`

1. Go to [GitHub Settings](https://github.com/settings/profile)
2. In the left sidebar, click **Developer settings**
3. Click **Personal access tokens** > **Fine-grained tokens**
4. Find the compromised token in the list
5. Click **Delete** next to the token
6. Confirm deletion when prompted

### Revoking OAuth Tokens - `gho_*`

OAuth tokens are typically generated by third-party applications. To revoke:

1. Go to [GitHub Settings](https://github.com/settings/profile)
2. In the left sidebar, click **Applications**
3. Click **Authorized OAuth Apps**
4. Find the application that generated the token
5. Click **Revoke** to invalidate all tokens for that application

**Note:** Revoking an OAuth app will invalidate ALL tokens issued by that app. You may need to re-authorize the application afterward.

### Revoking GitHub App Tokens - `ghs_*`, `ghr_*`

GitHub App installation tokens are managed differently:

1. Go to [GitHub Settings](https://github.com/settings/profile)
2. In the left sidebar, click **Applications**
3. Click **Installed GitHub Apps**
4. Find the compromised app installation
5. Click **Configure** next to the app
6. Scroll down and click **Uninstall** to revoke all tokens
7. Reinstall the app if needed

## Generating a New Token

### Creating a Fine-Grained Token (Recommended)

Fine-grained tokens offer better security through granular permissions:

1. Go to [GitHub Settings](https://github.com/settings/profile)
2. Click **Developer settings** > **Personal access tokens** > **Fine-grained tokens**
3. Click **Generate new token**
4. Configure the token:
   - **Token name**: Use a descriptive name (e.g., `weavertools-local-dev`)
   - **Expiration**: Set an appropriate expiration (recommended: 30-90 days)
   - **Repository access**: Select only the repositories needed
   - **Permissions**: Grant only the minimum permissions required:
     - For basic repo access: `Contents` (read/write)
     - For issues/PRs: `Issues` and `Pull requests` (read/write)
     - For actions: `Actions` (read/write)
5. Click **Generate token**
6. **Copy the token immediately** - it will not be shown again

### Creating a Classic Token

If fine-grained tokens aren't supported by your tooling:

1. Go to [GitHub Settings](https://github.com/settings/profile)
2. Click **Developer settings** > **Personal access tokens** > **Tokens (classic)**
3. Click **Generate new token** > **Generate new token (classic)**
4. Configure the token:
   - **Note**: Use a descriptive name
   - **Expiration**: Set an appropriate expiration
   - **Scopes**: Select only what's needed (usually `repo` for full repository access)
5. Click **Generate token**
6. **Copy the token immediately** - it will not be shown again

## Secure Token Storage

### Using .env Files (This Repository)

Store tokens in `.env` files that are gitignored:

```bash
# Navigate to the auto-claude directory
cd .auto-claude

# Copy the template
cp .env.example .env

# Edit with your token
nano .env  # or your preferred editor
```

Your `.env` file should look like:

```bash
# GitHub token for API access
GITHUB_TOKEN=ghp_your_new_token_here
```

### Best Practices for Token Storage

1. **Never commit tokens to version control**
   - All `.env` files are gitignored in this repository
   - Double-check with `git status` before committing

2. **Use environment-specific files**
   - `.env` - local development
   - `.env.local` - local overrides
   - Never create `.env.production` locally

3. **Set restrictive file permissions**
   ```bash
   chmod 600 .auto-claude/.env
   ```

4. **Consider using a secrets manager for production**
   - AWS Secrets Manager
   - HashiCorp Vault
   - 1Password/Bitwarden CLI

5. **Use the pre-commit hook**
   Install the secret detection hook to catch accidental commits:
   ```bash
   ./hooks/install.sh
   ```

## Post-Incident Audit

After revoking a compromised token, audit for unauthorized access:

### Check GitHub Security Log

1. Go to [GitHub Security Log](https://github.com/settings/security-log)
2. Filter by the time period of exposure
3. Look for:
   - Unexpected repository clones
   - API access from unknown IPs
   - Changes to repository settings
   - New deploy keys or webhooks

### Review Repository Activity

For each repository the token had access to:

1. Check **Insights** > **Network** for unexpected forks
2. Review **Settings** > **Webhooks** for unauthorized additions
3. Check **Settings** > **Deploy keys** for unknown keys
4. Review recent **Actions** runs for unexpected workflows

### If Unauthorized Access is Found

1. **Document everything** - timestamps, affected resources
2. **Rotate all related credentials** - not just the exposed token
3. **Check for persistence mechanisms** - unauthorized SSH keys, webhooks
4. **Consider enabling 2FA** if not already enabled
5. **Report to GitHub Security** if you find evidence of abuse

## Quick Reference

### Token Revocation URLs

- Personal Access Tokens (Classic): https://github.com/settings/tokens
- Fine-grained Tokens: https://github.com/settings/personal-access-tokens
- OAuth Applications: https://github.com/settings/applications
- Security Log: https://github.com/settings/security-log

### Emergency Checklist

- [ ] Token revoked on GitHub
- [ ] New token generated with minimal scopes
- [ ] `.env` file updated with new token
- [ ] Security log reviewed for unauthorized access
- [ ] Pre-commit hook installed to prevent future exposure
- [ ] Team notified if token was shared
